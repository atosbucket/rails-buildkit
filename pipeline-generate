#!/usr/bin/env ruby
# frozen_string_literal: true

def run(cmd, env={}, value=false)
  io = IO.popen(env, cmd)
  output = io.read
  io.close

  raise output unless $?.success?

  return output if value
end

env = {}

if ENV["BUILDKITE_PIPELINE_NAME"] == "rails-ci" || ENV["BUILDKITE_PIPELINE_NAME"] == "zzak/rails"
  env["BUNDLE_GEMFILE"] = ".buildkite/Gemfile"
end

run "bundle install", env

pipeline = run "bundle exec buildkite-builder preview rails-ci", env, true

puts pipeline
