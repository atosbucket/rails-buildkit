#!/usr/bin/env ruby
# frozen_string_literal: true

nightly = ARGV.include?("--nightly")

def run(cmd, env = {}, value = false)
  io = IO.popen(env, cmd)
  output = io.read
  io.close

  raise output unless $?.success?

  output if value
end

env = {}

if %w[rails-ci rails-ci-nightly rails-sandbox zzak/rails rails rails-nightly].include?(ENV["BUILDKITE_PIPELINE_SLUG"])
  env["BUNDLE_GEMFILE"] = ".buildkite/Gemfile"
end

run "bundle install", env

pipeline = run "bundle exec buildkite-builder preview rails-ci#{ "-nightly" if nightly }", env, true

puts pipeline
